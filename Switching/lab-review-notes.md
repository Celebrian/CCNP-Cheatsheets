# Lab Review Notes for Switching labs


# PAgP - LACP

## PAgP
Cisco proprietary
```txt
interface range f0/11-12
shutdown
(..)
channel-group 1 mode desirable
no shutdown
exit
interface port-channel 1
```

## LACP
```txt
interface range f0/7-8
shutdown
channel-group 2 mode active
no shutown
end
```
To check etherchannel 'show etherchannel summary'.
To change etherchannel load balancing 'port-channel load-balance ?'.


# STP

## Configuring a trunk
Configuring trunk:
```txt
conf t
int range f0/7-12
(switchport trunk encap dot1q)
switchport trunk native vlan 666
switchport trunk allowed vlan except 1,999
switchport mode trunk
switchport nonegotiate
no shutdown
exit
```

## Selecting STP root
```txt
conf t
spanning-tree vlan <vlan-id> root { primary | secondary }
```

## Changing port costs and priority
```txt
interface <interface>
spanning-tree cost <cost>
spanning-tree port-priority <port-priority>
```

## Select spanning tree protocol
```txt
conf t
spanning-tree mode {mst | pvst | rapid-pvst}
end
clear spanning-tree detected-protocols
```

## PortFast 
Only on acess ports:
```txt
interface <interface
spanning-tree portfast (trunk)
```
Set PortFast as default:
```txt
conf t
spanning-tree portfast default
```

## BPDU Guard
On all access ports:
```txt
interface <interface>
spanning-tree bpduguard enable
```


# MST (Multiple spanning tree)

## Configure MST
To enable:
```txt
conf t
spanning-tree mode mst
end
clear spanning-tree detected-protocols
```
To configure:
```txt
conf t
spanning-tree mst configuration
show current
show pending
```

## Configure mst root and priority
```txt
conf t
spanning-tree mst <instance-list> root {primary | secondary}
spanning-tree mst <instance-list> priority <priority>
```


# Inter-VLAN Routing
Turn on ip routing:
```txt
conf t
ip-routing
```

To convert links between layer 3 switches to an etherchannel and assign
the IP address 172.16.12.0/30:
```txt
interface range f0/11-12
no switchport
channel-group 2 mode desirable
no shutdown
exit
interface port-channel 2
ip address 172.16.12.1/2 255.255.255.252
no shutdown
exit
```
Configure default route:
```txt
ip route 0.0.0.0 0.0.0.0 port-channel 2 172.16.12.1/2
```
Set static route to 192.168.1.0/24 via vlan 110 and default route 10.1.99.1:
```txt
ip route 192.168.1.0 255.255.255.0 vlan 110
ip route 0.0.0.0 0.0.0.0 10.1.99.1
```


# DHCP

## DHCP server for ipv4

```txt
conf t
ip dhcp excluded-address (starting ip) (ending ip)
ip dhcp pool <name>
network <ip> <subnet>
default-router <ip>
dns-server <ip>
```

## Stateless DHCP ipv6 server

On L3 switches only:
```txt
conf t
ipv6 dhcp pool <name>
dns-server <ipv6>
exit
interface <interface> 
ipv6 dhcp server <name>
ipv6 nd other-config-flag
```

### DHCP Relay
Redirect IPv4 and IPv6 DHCP requests to DLS1 at 10.1.99.1 and 2001:db8:3115:99::d1 respectively:
```txt
interface vlan 120
ipv6 dhcp relay destination 2001:db8:3115:99::d1 po2
ip helper-address 10.1.99.1
```

## Stateful DHCP for ipv6
```txt
conf t
ipv6 dhcp pool VLAN120-IPV6-POOL
address prefix 2001:db8:3115:120::/64
dns-server 2001:db8:3115:99::100
domain-name switch.ccnp
interface po2
ipv6 dhcp server VLAN120-IPV6-POOL
interface vlan 120
ipv6 nd prefix <ipv6> no-autoconfig
```

# First Hop Redundancy Protocols

## HSRP (Hot Standby Router Protocol)
Cisco propietary
L2 switches need a default gateway to sent traffic outside the local subnet. `ip default-gateway <ip>`
Can only be done on L3 switches (for routing).
Standby is the keyword for configuring the virtual gateway.
Preemtion makes the higher priority to be the active router always.
If no priority is spesified, default for HSPR is 100
```txt
conf t
ip routing
interface vlan <number>
ip address <ip> <subnett>
standby <same number as vlan> ip <virtual gateway ip>
standby <--------- || ------> preempt
standby <--------- || ------> priority <priority>
```

### HSRP autentication
```txt
interface vlan <number>
standby <same number as vlan> authentication md5 key-string <password>
```

### HSRP interface tracking
```txt
conf t
ip sla <number>
icmp-echo <ip to monitor>
frequency <seconds>
exit
ip sla schedule <number> life forever start-time now
track <object number> ip sla <number>
interface vlan <number>
standby <number> track <object number> decrement 70
```

### HSRP for IPv6
Remember `ipv6 unicast-routing` to enable ipv6 routing.
`standby version 2` on each interface running HSRP(all vlans).
A virtual ip can be autogenerated with `standby X ipv6 autoconfig.
Example:
```txt
interface vlan 120
ipv6 address 2001:DB8:CAFE:120::D1/64
ipv6 address FE80::D1 link-local
standby version 2
standby 120 ipv6 autoconfig
standby 120 priority 110
standby 120 preempt
ipv6 eigrp 1
no shutdown
exit
``` 
Track with: `standby <HSRP number> track <interface> <decrement value>`
Make sure the decrement value is over the difference in priority between master and backup priority, default is 10.
Example on tracking with decrement value 30:
```txt
interface vlan 120
standby 120 track fastEthernet 0/5 30
```

## VRRP (Virtual Router Redundancy Protocol)
Default priority is 100.
```txt
interface <vlan>
ip address <ip> <subnett>
vrrp <vlan> ip <virtual gateway ip>
vrrp <vlan> priority <priority>
```

### VRRP tracking
VRRP can only do object tracking, not interface tracking
```txt
conf t
track <number> interface <interface> line-protocol
interface <vlan-interface>
vrrp <vlan> track <number> decrement <60> 
```
The amount to decrement should be more than the difference between master and backup priority


## GLBP (Gateway Load Balancing Protocol)

### Configure GLBP
In this example the address with .254 is the standby address:
```txt
interface GigabitEthernet0/1.20
glbp 20 ip 10.1.20.254
glbp 20 priority 150
glbp 20 preemt
```

### GLBP tracking
```txt
conf t
track 20 interface s0/0/0 line-protocol
interface gi 0/1.10
glbp weighting 110 lower 85 upper 105
glbp weighting track 20 decrement 30
```

### GLBP authentication
```txt
interface GigabitEthernet0/1.10
glbp 10 authentication md5 key-string cisco123
```

# NTP (Network Time Protocol)
Set the time with `clock set <hh:mm:ss> <dayOfMonth> <Month> <Year>`
Change timezone with `clock timesone <nameOfZone> <hourOffset> (<minuteOffsett>)`

A higher stratum number means less reliable
Start an ntp master with `ntp master <stratum number>`
For other clients connect with `ntp server <A.B.C.D>` then set timezone.

Setup NTP authentication like so:
```txt
conf t
ntp authenticate
ntp authentication-key 1 md5 <passphrase>
ntp trusted-key 1
```


# IP SLA and RSPAN

## Cisco IOS IP SLA
If the test is tcp-connect or udp-echo, it might need a responder on the reciving end. Set this up with:
```txt
conf t
ip sla responder {tcp-connect | udp-echo} ipaddress <ip> port {<port | 5000}
```
Setup a icmp-echo sla like so:
```txt
conf t
ip sla <number
icmp-echo <ip>
```
Setup an udp-jitter sla like so:
```txt
ip sla <number>
udp-jitter <ip>
```
Schedule them to start now and live forever:
```txt
ip sla schedule <number> life forever start now
```

## RSPAN
First setup a vlan for RSPAN traffic
```txt
conf t
vlan 300
name REMOTE_SPAN
remote-span
```
Example monitoring all traffic on an interface and sending it to a remote vlan:
```txt
monitor session <number> source interface <interface>
monitor session <number> destination remote vlan 300
```
Reciving on the vlan gateway and sending to a computer running a protocol analyzer:
```txt
monitor session <number> source remote vlan 300
monitor session <number> destination interface <interface>
```

# Securing L2 Switches
 
## Storm control
Unicast storms start at 65% and end when under 35%
Broadcast storm start at 1000 pps end at 300pps
Multicast storm start at 40% end at 25%
Action can be trap or shutdown
```txt
interface range <interface range>
storm-control unicast level 65 35
storm-control broadcast level pps 1k 300
storm-control multicast level 40 25
storm-control action trap
```

## Port security
To enable first issue `switchport port-security` on the interface
That will set max MAC addresses to 1, and violation mode to shutdown.(Check)
To set number of allowed MAC addresses and add them to the running config:
```txt
interface range <interface range>
switchport port-security
switchport port-security maximum 2
switchport port-security mac-address sticky
```
To configure auto recover from err-disable:
```txt
conf t
errdisable recovery cause psecure-violation
errdisable recovery interval <timeInSec>
```

## DHCP Snooping IPv4
Turn on DHCP Snooping with `ip dhcp snooping` command.
Default is untrusted, so say trust on interfaces you need it,
set snooping limit on untrusted ports to limit amount of dhcp requests,
turn on dhcp snooping on spesific vlans(here 100 and 200)
```txt
conf t
ip dhcp snooping
interface range <interface range>
ip dhcp snooping trust
interface range <interface range>
ip dhcp snooping limit rate <rate in pps>
exit
ip dhcp snooping vlan 100,200
```

## AAA with a radius server
Enable AAA with `aaa new-model` from global config
Add a user, setup radius server with authentication and accounting port and shared key
Setup loginf from that with fallback to local database
Enable on VTY lines:
```txt
conf t
aaa new-model
username <name> privilege 15 password <password>
radius server <Rname>
address ipv4 <ip> auth-port <port> acct-port <port>
key <sharedKey>
exit
aaa authentication login <loginGroupName> group radius local
line vty 0 4
login authentication <loginGroupName>
```

# Securing VLANs

## Private VLANs
Need vtp version 3: `vtp version 3` from global config
vtp password with `vtp password cisco 123`
Configure the primary switch: `vtp primary vlan`
Create a vlan and set STP root:
```
conf t
vlan <number>
name <name>
exit
spanning-tree vlan <number> root primary
```
A secondary vlan can be community or isolated.
Community means they can communicate with other hosts in that vlan and the primary vlan
Isolated means they can only communicate with the primary vlan.
Only if it is a primary vlan can assosiation be set, community and isolated will run on the primary vlan.
```txt
vlan <number>
private-vlan {primary | isolated | community}
private-vlan assosiation <vlans>
```
To allow the secondary vlans to be L3 routed in the primary vlan:
```txt
interface vlan <primary vlan>
private-vlan mapping <secondary vlans>
```
To set host access to private vlans:
```txt
interface <interface>
switchport mode private-vlan host
switchport private-clan host-association <primary vlan id> <secondary vlan id>
```

## RACLs (Router Access Control Lists
Configure access list (source -> destination)
```txt
conf t
access-list <number> {premit | deny} <protocol> <network ip> <wildcard mask> <network ip> <wildcard mask>
interface <interface>
ip access-group <number> {in | out}
```

## VACLs (Vlan ACLs)
Here we setup an access list that drop ip and icmp traffic but allows everything else.
There is an implisit deny all at the end,so we add `action forward`
Then apply the access map with vla filter
```txt
conf t
ip access-list extended <name>
permit ip host <dest-network> <wildcard-mask>
permit icmp host <dest-network> <wildcard-mask>
exit
vlan access-map <other name> <sequence number>
match ip address <name>
action drop
vlan access-map <other name> <higher sequence number>
action forward
exit
vlan filter <other name> vlan-list <vlan>
```
